name: mcxtrace-conda-basictest
on:
  push:
  pull_request:
  schedule:
    - cron: '55 23 * * 0'  # 23:55 every Sunday

  workflow_dispatch:
    inputs:
      manual-debugging:
        type: boolean
        description: Launch manual debugging tmate for inspection (automatic in case of errors)
        default: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest, python: '3.12', mpi: 'openmpi' }
          - { os: ubuntu-latest, python: '3.12', mpi: 'mpich' }
          - { os: macos-latest, python: '3.12', mpi: 'openmpi' }
          - { os: macos-latest, python: '3.12', mpi: 'mpich' }
          - { os: windows-latest, python: '3.12', mpi: 'msmpi' }

    name: ${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    env:
      CC: ${{ matrix.CC }}
      CXX: ${{ matrix.CXX }}
    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        path: src
        fetch-depth: 2

    - name: Setup VS in shell Intel
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - uses: conda-incubator/setup-miniconda@v3
      with:
        activate-environment: mcxtrace
        auto-update-conda: true
        conda-remove-defaults: true
        channels: conda-forge
        python-version: ${{ matrix.python }}

    - name: Setup conda
      id: setup-conda
      run: |
           ./src/devel/bin/mccode-create-conda-yml -m mcxtrace -n mcxtrace -o dependencies.yml
           conda env update --file dependencies.yml
           echo DONE

    - name: Check versions
      id: version-checks
      run: |
           which python3
           python3 --version
           which cmake
           cmake --version
           if [ "$RUNNER_OS" != "Windows" ];
           then
             echo C compiler: $CC
             $CC --version
           else
             echo C compiler: cl.exe
             cl.exe
           fi

    - name: Configure build and install mcxtrace
      id: mcxtrace-install
      run: |
           ./src/devel/bin/mccode-build-conda -m mcxtrace -s $PWD/src -b $PWD/build_mcxtrace

    - name: Post install openmpi hacks macOS
      id: post-install-openmpi-hacks-macOS
      if: runner.os == 'macOS' 
      run: |
             if [ "${{ matrix.mpi }}" == "openmpi" ]; then
               sed -i.bak 's+mpirun+mpirun\ -mca\ regx\ naive\ --verbose\ --mca\ btl_tcp_if_include\ lo0+g' ${CONDA_PREFIX}/share/mcxtrace/tools/Python/mccodelib/mccode_config.json
             fi

     # Start of Unix tests
    - name: Launch RNG test instrument
      id: RNG-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MCXTRACE_PYGEN_EXECUTABLE="mcxtrace-pygen"
           export MXRUN_EXECUTABLE="mxrun"
           export MD5SUM="md5sum"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCXTRACE_EXECUTABLE="mcxtrace.exe"
             export MCXTRACE_PYGEN_EXECUTABLE="mcxtrace-pygen.exe"
             export MXRUN_EXECUTABLE="mxrun.bat"
           fi
           if [ "$RUNNER_OS" == "macOS" ];
           then
             export MD5SUM="md5"
           fi
           test -f ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE}
           ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE} --version
           mkdir run_RNG && cd run_RNG
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/Tests_RNG/Test_RNG_rand01/Test_RNG_rand01.instr .
           ../install_mcxtrace/bin/${MXRUN_EXECUTABLE} Test_RNG_rand01.instr -s1000 Ncount=1000 -d RNGtest
           export SUM=`grep -v \# RNGtest/rngout.dat | ${MD5SUM} | cut -f1 -d\ `
           export EXPECTED="f192ce4609e2225bf9d42ce9c5fa5a86"
           if [ "${EXPECTED}" == "${SUM}" ];
           then
              echo RNG test success!
              true
           else
              echo RNG test failure!
              false
           fi

    - name: Launch JJ_SAXS instrument
      id: JJ_SAXS-basic
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MCXTRACE_PYGEN_EXECUTABLE="mcxtrace-pygen"
           export MXRUN_EXECUTABLE="mxrun"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCXTRACE_EXECUTABLE="mcxtrace.exe"
             export MCXTRACE_PYGEN_EXECUTABLE="mcxtrace-pygen.exe"
             export MXRUN_EXECUTABLE="mxrun.bat"
           fi
           test -f ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE}
           ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE} --version
           mkdir run_JJ_SAXS && cd run_JJ_SAXS
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/SAXSLAB/JJ_SAXS/JJ_SAXS.instr .
           ../install_mcxtrace/bin/${MXRUN_EXECUTABLE} JJ_SAXS.instr pin2_pos=0.2 pin3_pos=0.4 optic_L=0.1 sample_pos=0.2 detector_pos=2
           ../install_mcxtrace/bin/${MCXTRACE_PYGEN_EXECUTABLE} JJ_SAXS.instr

    - name: Launch JJ_SAXS instrument (MPI)
      id: JJ_SAXS-mpi
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MCXTRACE_PYGEN_EXECUTABLE="mcxtrace-pygen"
           export MXRUN_EXECUTABLE="mxrun"
           if [ "$RUNNER_OS" == "macOS" ]; then export TMPDIR=${HOME}/tmp; fi
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCXTRACE_EXECUTABLE="mcxtrace.exe"
             export MXRUN_EXECUTABLE="mxrun.bat"
           fi
           test -f ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE}
           ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE} --version
           mkdir run_JJ_SAXS_mpi && cd run_JJ_SAXS_mpi
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/SAXSLAB/JJ_SAXS/JJ_SAXS.instr .
           ../install_mcxtrace/bin/${MXRUN_EXECUTABLE} --verbose --mpi=2 JJ_SAXS.instr pin2_pos=0.2 pin3_pos=0.4 optic_L=0.1 sample_pos=0.2 detector_pos=2

    - name: Launch MCPL test instrument
      id: mcpl-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MXRUN_EXECUTABLE="mxrun"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCXTRACE_EXECUTABLE="mcxtrace.exe"
             export MXRUN_EXECUTABLE="mxrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcxtrace/bin/:${PWD}/install_mcxtrace/mcxtrace/3.99.99/bin/
           test -f ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE}
           ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE} --version
           mkdir run_Test_MCPL_input && cd run_Test_MCPL_input
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/Tests_MCPL_etc/Test_MCPL_input/Test_MCPL_input.instr .
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/Tests_MCPL_etc/Test_MCPL_input/voutput.mcpl.gz .
           ../install_mcxtrace/bin/${MXRUN_EXECUTABLE} Test_MCPL_input.instr repeat=10 MCPLFILE=voutput.mcpl.gz

    - name: Launch MCPL test instrument (MPI)
      id: mcpl-test-mpi
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MXRUN_EXECUTABLE="mxrun"
           if [ "$RUNNER_OS" == "macOS" ]; then export TMPDIR=${HOME}/tmp; fi
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCXTRACE_EXECUTABLE="mcxtrace.exe"
             export MXRUN_EXECUTABLE="mxrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcxtrace/bin/:${PWD}/install_mcxtrace/mcxtrace/3.99.99/bin/
           test -f ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE}
           ./install_mcxtrace/bin/${MCXTRACE_EXECUTABLE} --version
           mkdir run_Test_MCPL_input_mpi && cd run_Test_MCPL_input_mpi
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/Tests_MCPL_etc/Test_MCPL_input/Test_MCPL_input.instr .
           cp ../install_mcxtrace/share/mcxtrace/resources/examples/Tests_MCPL_etc/Test_MCPL_input/voutput.mcpl.gz .
           ../install_mcxtrace/bin/${MXRUN_EXECUTABLE} --verbose --mpi=2 Test_MCPL_input.instr repeat=20 MCPLFILE=voutput.mcpl.gz

    - name: Check for modified instruments
      id: instr-test
      run: |
           set -e
           set -u
           set -x
           export MCXTRACE_EXECUTABLE="mcxtrace"
           export MXRUN_EXECUTABLE="mxrun"
           export MXTEST_EXECUTABLE="mxtest"
           export PATH=${PATH}:${PWD}/install_mcxtrace/bin/:${PWD}/install_mcxtrace/mcxtrace/3.99.99/bin/
           # Check if any instr files were modified during last commit
           cd src
           export CHANGEDCOMPS=`git diff --name-only HEAD HEAD~1| grep \.comp\$ | grep mcxtrace-comps | xargs -n1 basename | sed s/\.comp//g | xargs echo`
           export NUMCHANGEDCOMPS=`git diff --name-only HEAD HEAD~1|grep \.comp\$ | grep mcxtrace-comps | wc -l | xargs echo`
           export COMPILIST=""
           export RUNALL="NO"
           if [ "$NUMCHANGEDCOMPS" != "0" ];
           then
             if [ "$NUMCHANGEDCOMPS" -lt "10" ];
             then
               for comp in $CHANGEDCOMPS;
               do
                 echo Finding instruments matching component $comp
                 MATCH=`find mcxtrace-comps -name \*.instr -exec grep -H ${comp} \{\} \; | cut -f1 -d: | sort | uniq | xargs -n1 basename | sed s/\.instr//g | xargs echo`
                 export COMPILIST=`echo $COMPILIST $MATCH`
               done
             else
               export RUNALL="YES"
             fi
           fi
           export CHANGEDINSTR=`git diff --name-only HEAD HEAD~1| grep \.instr\$ | grep mcxtrace-comps | xargs -n1 basename | sed s/\.instr//g | xargs echo`
           export CHANGEDINSTR=`echo $CHANGEDINSTR $COMPILIST | sort | uniq | sed s/\ /,/g`
           export NUMCHANGEDINSTR=`git diff --name-only HEAD HEAD~1|grep \.instr\$ | grep mcxtrace-comps | wc -l | xargs echo`
           echo ----
           echo $NUMCHANGEDCOMPS components and $NUMCHANGEDINSTR instruments were changed, resulting in this list:
           echo $CHANGEDINSTR
           echo ----
           cd -
           if [ "$NUMCHANGEDINSTR" -gt "10" ];
           then
             export RUNALL="YES"
           fi
           export PERMISSIVE=" "
           if [ "$NUMCHANGEDINSTR" != "0" ] || [ "$NUMCHANGEDCOMPS" != "0" ];
           then
             if [ "$RUNALL" == "NO" ];
             then
               export SCOPE="--instr=$CHANGEDINSTR"
             else
               export SCOPE=" "
             fi
             if [ "$RUNNER_OS" != "Windows" ]; then
               mkdir run_mxtest && cd run_mxtest
               if [ "$RUNNER_OS" == macOS ]; then
                 export PERMISSIVE="--permissive"
               fi
               ../install_mcxtrace/bin/${MXTEST_EXECUTABLE} --testdir $PWD $SCOPE --suffix=CHANGES $PERMISSIVE
               mxviewtest --nobrowse $PWD
             else
               echo ..\\install\\bin\\mxtest --verbose --testdir=. $SCOPE --suffix=CHANGES --permissive > changedinstr.bat
             fi
           fi

    # END of Unix tests

    - name: Run modified instruments Win
      id: instr-test-Win
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      run: |
        if exist changedinstr.bat (
          mkdir run_mxtest
          cd run_mxtest
          call ..\changedinstr.bat
        )

    # Start of Windows tests
    - name: Prepare rundirs Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      run: mkdir run_rng run_std run_mcpl_output run_mcpl_input run_union

    - name: Prepare and run rng instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_rng
      run: |
        copy ..\install\share\mcxtrace\resources\examples\Tests_RNG\Test_RNG_rand01\Test_RNG_rand01.instr test.instr
        ..\install\bin\mxrun --verbose test.instr -s1000 Ncount=1000 -d RNGtest

    - name: Prepare and run CRL instrument Windows MSVC
      if: runner.os == 'Windows' && matrix.cc != 'gcc.exe' # Windows MSVC only
      shell: cmd
      working-directory: run_std
      run: |
        copy ..\install\share\mcxtrace\resources\examples\Tests_optics\Test_CRL\Test_CRL.instr test.instr
        ..\install\bin\mxrun --verbose test.instr -s1000 -y

    - name: Prepare and run MCPL_input instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_mcpl_input
      run: |
        copy ..\install\share\mcxtrace\resources\examples\Tests_MCPL_etc\Test_MCPL_input\Test_MCPL_input.instr test.instr
        copy ..\install\share\mcxtrace\resources\examples\Tests_MCPL_etc\Test_MCPL_input\voutput.mcpl.gz .
        ..\install\bin\mxrun --verbose test.instr -s1000 -y

    - name: Prepare and run MCPL_output instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_mcpl_output
      run: |
        copy ..\install\share\mcxtrace\resources\examples\Tests_MCPL_etc\Test_MCPL_output\Test_MCPL_output.instr test.instr
        ..\install\bin\mxrun --verbose test.instr -s1000 -y

    - name: Test RNG instrument output Windows
      if: runner.os == 'Windows' # Windows only
      working-directory: run_rng
      shell: bash
      run:   |
        export SUM=`grep -v \# RNGtest/rngout.dat | dos2unix | md5sum | cut -f1 -d\ `
        export EXPECTED="f192ce4609e2225bf9d42ce9c5fa5a86"
        if [ "${EXPECTED}" == "${SUM}" ];
        then
          echo RNG test success!
          true
        else
          echo RNG test failure!
          false
        fi
    # END of Windows tests

    - name: 'Tar output files'
      id: tar-package
      if: always()
      run: |
           set -e
           set -u
           set -x
           tar cvfz mcxtrace-${{ matrix.os }}.${{ matrix.CC }}.${{ matrix.mpi }}.python-${{ matrix.python }}_output.tgz run_*

    - name: 'Upload Artifact'
      id: tar-upload
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mcxtrace-artefacts-${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}
        path: "mcxtrace-${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}_output.tgz"

    - name: Setup tmate session for manual debugging
      uses: mxschmitt/action-tmate@v3
      if: always() && (inputs.manual-debugging == true)
      with:
        limit-access-to-actor: true
