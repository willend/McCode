name: mcstas-conda-basictest
on:
  push:
  pull_request:
  schedule:
    - cron: '30 23 * * 0'  # 23:30 every Sunday

  workflow_dispatch:
    inputs:
      manual-debugging:
        type: boolean
        description: Launch manual debugging tmate for inspection (automatic in case of errors)
        default: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest, python: '3.12', mpi: 'openmpi' }
          - { os: ubuntu-latest, python: '3.12', mpi: 'mpich' }
          - { os: macos-latest, python: '3.12', mpi: 'openmpi' }
          - { os: macos-latest, python: '3.12', mpi: 'mpich' }
          - { os: windows-latest, python: '3.12', mpi: 'msmpi' }

    name: ${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    env:
      CC: ${{ matrix.CC }}
      CXX: ${{ matrix.CXX }}
    defaults:
      run:
        shell: bash -el {0}

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        path: src
        fetch-depth: 2

    - name: Setup VS in shell Intel
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - uses: conda-incubator/setup-miniconda@v3
      with:
        activate-environment: mcstas
        auto-update-conda: true
        conda-remove-defaults: true
        channels: conda-forge
        python-version: ${{ matrix.python }}

    - name: Setup conda
      id: setup-conda
      run: |
           ./src/devel/bin/mccode-create-conda-yml -m mcstas -n mcstas -o dependencies.yml
           conda env update --file dependencies.yml
           echo DONE

    - name: Check versions
      id: version-checks
      run: |
           which python3
           python3 --version
           which cmake
           cmake --version
           if [ "$RUNNER_OS" != "Windows" ];
           then
             echo C compiler: $CC
             $CC --version
           else
             echo C compiler: cl.exe
             cl.exe
           fi

    - name: Configure build and install mcstas
      id: mcstas-install
      run: |
           ./src/devel/bin/mccode-build-conda -m mcstas -s $PWD/src -b $PWD/build_mcstas

    - name: Post install openmpi hacks macOS
      id: post-install-openmpi-hacks-macOS
      if: runner.os == 'macOS' 
      run: |
           if [ "${{ matrix.mpi }}" == "openmpi" ]; then
               sed -i.bak 's+mpirun+mpirun\ -mca\ regx\ naive\ --verbose\ --mca\ btl_tcp_if_include\ lo0+g' ${CONDA_PREFIX}/share/mcstas/tools/Python/mccodelib/mccode_config.json
           fi

    # Start of Unix tests
    - name: Launch RNG test instrument
      id: RNG-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen"
           export MCRUN_EXECUTABLE="mcrun"
           export MD5SUM="md5sum"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           if [ "$RUNNER_OS" == "macOS" ];
           then
             export MD5SUM="md5"
           fi
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_RNG && cd run_RNG
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/Tests_RNG/Test_RNG_rand01/Test_RNG_rand01.instr .
           ${MCRUN_EXECUTABLE} Test_RNG_rand01.instr -s1000 Ncount=1000 -d RNGtest
           export SUM=`grep -v \# RNGtest/rngout.dat | ${MD5SUM} | cut -f1 -d\ `
           export EXPECTED="f192ce4609e2225bf9d42ce9c5fa5a86"
           if [ "${EXPECTED}" == "${SUM}" ];
           then
              echo RNG test success!
              true
           else
              echo RNG test failure!
              false
           fi

    - name: Launch BNL_H8 instrument
      id: h8-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_BNL_H8 && cd run_BNL_H8
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/BNL/BNL_H8/BNL_H8.instr .
           ${MCRUN_EXECUTABLE} BNL_H8.instr lambda=2.36
           ${MCSTAS_PYGEN_EXECUTABLE} BNL_H8.instr

    - name: Launch BNL_H8 instrument (MPI)
      id: h8-test-mpi
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "macOS" ]; then export TMPDIR=${HOME}/tmp; fi
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCSTAS_PYGEN_EXECUTABLE="mcstas-pygen.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_BNL_H8_mpi && cd run_BNL_H8_mpi
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/BNL/BNL_H8/BNL_H8.instr .
           ${MCRUN_EXECUTABLE} --verbose --mpi=2 BNL_H8.instr lambda=2.36

    - name: Launch MCPL test instrument
      id: mcpl-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_ESS_BEER_MCPL && cd run_ESS_BEER_MCPL
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/ESS/ESS_BEER_MCPL/* .
           ${MCRUN_EXECUTABLE} ESS_BEER_MCPL.instr repetition=50

    - name: Launch MCPL test instrument (mpi)
      id: mcpl-test-mpi
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "macOS" ]; then export TMPDIR=${HOME}/tmp; fi
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_ESS_BEER_MCPL_mpi && cd run_ESS_BEER_MCPL_mpi
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/ESS/ESS_BEER_MCPL/* .
            ${MCRUN_EXECUTABLE} --verbose --mpi=2 ESS_BEER_MCPL.instr repetition=100

    - name: Launch NCrystal test instrument
      id: ncrystal-test
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_NCrystal_example && cd run_NCrystal_example
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/NCrystal/NCrystal_example/NCrystal_example.instr .
            ${MCRUN_EXECUTABLE} NCrystal_example.instr sample_cfg="Y2O3_sg206_Yttrium_Oxide.ncmat;density=0.6x"

    - name: Launch NCrystal test instrument (mpi)
      id: ncrystal-test-mpi
      if: runner.os != 'Windows'
      # Status: Works on Unixes
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           if [ "$RUNNER_OS" == "macOS" ]; then export TMPDIR=${HOME}/tmp; fi
           if [ "$RUNNER_OS" == "Windows" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_NCrystal_example_mpi && cd run_NCrystal_example_mpi
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/NCrystal/NCrystal_example/NCrystal_example.instr .
           ncrystal-config --version
           export NUM_MPI=2
           ${MCRUN_EXECUTABLE} --verbose --mpi=${NUM_MPI} NCrystal_example.instr sample_cfg="Y2O3_sg206_Yttrium_Oxide.ncmat;density=0.6x"

    - name: Launch NeXus test instrument
      id: nexus-test
      if: runner.os == 'Linux' # Linux only
      # Status: Works on Linux (NeXus packages w/napi.h missing on mac+Windows)
      run: |
           set -e
           set -u
           set -x
           sudo apt-get update
           sudo apt-get -y install libnexus-dev
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           if [ "x$(uname | cut -f1 -d_)" == "xMINGW64" ];
           then
             export MCSTAS_EXECUTABLE="mcstas.exe"
             export MCRUN_EXECUTABLE="mcrun.bat"
           fi
           test -f ${CONDA_PREFIX}/bin/${MCSTAS_EXECUTABLE}
           ${MCSTAS_EXECUTABLE} --version
           mkdir run_templateSANS_Mantid && cd run_templateSANS_Mantid
           cp ${CONDA_PREFIX}/share/mcstas/resources/examples/Mantid/templateSANS_Mantid/templateSANS_Mantid.instr .
           #Not a final solution!!!:
           #if [ "x$(uname)" == "xDarwin" ]; then export MCSTAS_CC_OVERRIDE=/usr/bin/clang; fi
           if [ "x$(uname)" == "xLinux" ]; then
             ${MCRUN_EXECUTABLE} --format=NeXus --IDF templateSANS_Mantid.instr lambda=6
             ${MCRUN_EXECUTABLE} -c --verbose --mpi=2 --format=NeXus --IDF templateSANS_Mantid.instr lambda=6
           fi

    - name: Check for modified instruments
      id: instr-test
      run: |
           set -e
           set -u
           set -x
           export MCSTAS_EXECUTABLE="mcstas"
           export MCRUN_EXECUTABLE="mcrun"
           export MCTEST_EXECUTABLE="mctest"
           export PATH=${PATH}:${PWD}/install_mcstas/bin/:${PWD}/install_mcstas/mcstas/3.99.99/bin/
           # Check if any instr files were modified during last commit
           cd src
           export CHANGEDCOMPS=`git diff --name-only HEAD HEAD~1| grep \.comp\$ | grep mcstas-comps | xargs -n1 basename | sed s/\.comp//g | xargs echo`
           export NUMCHANGEDCOMPS=`git diff --name-only HEAD HEAD~1|grep \.comp\$ | grep mcstas-comps | wc -l | xargs echo`
           export COMPILIST=""
           export RUNALL="NO"
           if [ "$NUMCHANGEDCOMPS" != "0" ];
           then
             if [ "$NUMCHANGEDCOMPS" -lt "10" ];
             then
               for comp in $CHANGEDCOMPS;
               do
                 echo Finding instruments matching component $comp
                 MATCH=`find mcstas-comps -name \*.instr -exec grep -H ${comp} \{\} \; | cut -f1 -d: | sort | uniq | xargs -n1 basename | sed s/\.instr//g | xargs echo`
                 export COMPILIST=`echo $COMPILIST $MATCH`
               done
             else
               export RUNALL="YES"
             fi
           fi
           export CHANGEDINSTR=`git diff --name-only HEAD HEAD~1| grep \.instr\$ | grep mcstas-comps | xargs -n1 basename | sed s/\.instr//g | xargs echo`
           export CHANGEDINSTR=`echo $CHANGEDINSTR $COMPILIST | sort | uniq | sed s/\ /,/g`
           export NUMCHANGEDINSTR=`git diff --name-only HEAD HEAD~1|grep \.instr\$ | grep mcstas-comps | wc -l | xargs echo`
           echo ----
           echo $NUMCHANGEDCOMPS components and $NUMCHANGEDINSTR instruments were changed, resulting in this list:
           echo $CHANGEDINSTR
           echo ----
           cd -
           if [ "$NUMCHANGEDINSTR" -gt "10" ];
           then
             export RUNALL="YES"
           fi
           export PERMISSIVE=" "
           if [ "$NUMCHANGEDINSTR" != "0" ] || [ "$NUMCHANGEDCOMPS" != "0" ];
           then
             if [ "$RUNALL" == "NO" ];
             then
               export SCOPE="--instr=$CHANGEDINSTR"
             else
               export SCOPE=" "
             fi
             if [ "$RUNNER_OS" != "Windows" ]; then
               mkdir run_mctest && cd run_mctest
               if [ "$RUNNER_OS" == macOS ]; then
                 export PERMISSIVE="--permissive"
               fi
               ${MCTEST_EXECUTABLE} --testdir $PWD $SCOPE --suffix=CHANGES $PERMISSIVE
               mcviewtest --nobrowse $PWD
             else
               echo mctest --verbose --testdir=. $SCOPE --suffix=CHANGES --permissive > changedinstr.bat
             fi
           fi

    # END of Unix tests

    - name: Run modified instruments Win
      id: instr-test-Win
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      run: |
        if exist changedinstr.bat (
          mkdir run_mctest
          cd run_mctest
          call ..\changedinstr.bat
        )

    # Start of Windows tests
    - name: Prepare rundirs Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      run: mkdir run_rng run_std run_mcpl_output run_mcpl_input run_mcpl_input_once run_union run_ncrystal

    - name: Prepare and run rng instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_rng
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_RNG\Test_RNG_rand01\Test_RNG_rand01.instr test.instr
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 Ncount=1000 -d RNGtest

    - name: Prepare and run BNL_H8 instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_std
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\BNL\BNL_H8\BNL_H8.instr test.instr
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 -y

    - name: Prepare and run NCrystal instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_ncrystal
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\NCrystal\NCrystal_example\NCrystal_example.instr test.instr
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 -y

    - name: Prepare and run MCPL_input instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_mcpl_input
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_MCPL_etc\Test_MCPL_input\Test_MCPL_input.instr test.instr
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_MCPL_etc\Test_MCPL_input\voutput.mcpl.gz .
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 -y

    - name: Prepare and run MCPL_input_once instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_mcpl_input_once
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_MCPL_etc\Test_MCPL_input_once\Test_MCPL_input_once.instr test.instr
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_MCPL_etc\Test_MCPL_input_once\voutput.mcpl.gz .
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 -y

    - name: Prepare and run MCPL_output instrument Windows
      if: runner.os == 'Windows' # Windows only
      shell: cmd
      working-directory: run_mcpl_output
      run: |
        copy %CONDA_PREFIX%\share\mcstas\resources\examples\Tests_MCPL_etc\Test_MCPL_output\Test_MCPL_output.instr test.instr
        %CONDA_PREFIX%\bin\mcrun --verbose test.instr -s1000 -y

    - name: Test RNG instrument output Windows
      if: runner.os == 'Windows' # Windows only
      working-directory: run_rng
      shell: bash
      run:   |
        export SUM=`grep -v \# RNGtest/rngout.dat | dos2unix | md5sum | cut -f1 -d\ `
        export EXPECTED="f192ce4609e2225bf9d42ce9c5fa5a86"
        if [ "${EXPECTED}" == "${SUM}" ];
        then
          echo RNG test success!
          true
        else
          echo RNG test failure!
          false
        fi
    # END of Windows tests

    - name: 'Tar output files'
      id: tar-package
      if: always()
      run: |
           set -e
           set -u
           set -x
           tar cvfz mcstas-${{ matrix.os }}.${{ matrix.CC }}.${{ matrix.mpi }}.python-${{ matrix.python }}_output.tgz run_*

    - name: 'Upload Artifact'
      id: tar-upload
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mcstas-artefacts-${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}
        path: "mcstas-${{ matrix.os }}.${{ matrix.mpi }}.python-${{ matrix.python }}_output.tgz"

    - name: Setup tmate session for manual debugging
      uses: mxschmitt/action-tmate@v3
      if: always() && (inputs.manual-debugging == true)
      with:
        limit-access-to-actor: true
