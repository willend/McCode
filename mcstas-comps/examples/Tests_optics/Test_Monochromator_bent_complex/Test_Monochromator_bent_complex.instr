/*******************************************************************************
* Instrument: Test_Monochromator_bent_complex
*
* %Identification
* Written by: Jakob Lass (jakob.lass@psi.ch)
* Date: 20250702
* Origin: PSI/LSN
* %INSTRUMENT_SITE: Tests_optics
*
* This is a first draft for the WARP instrument proposal, as created by
* Daniel Gabriel Mazzone (daniel.mazzone@psi.ch) and Jakob Lass 
* (jakob.lass@psi.ch). This proposal will include a new component which utilizes
* the marmot geometery. The instrument only looks at the backend of the instrument
* from the sample to the detector, as the guide part of the instrument is not 
* fully planned out yet.
*
* %D
* Used as a test instrument to highlight Monochromator Bent complex's capabilities
*
* %Example: Test_Monochromator_bent_complex.instr mos=60 Detector: E_PSD_mon_end_I=0.000215194
*
* %Parameters
* sample_x: [m] Source horz illumination
* sample_y: [m] Source vert illumination
* L0:       [m] Z-displacement of detector wrt. rotation point
* L1:       [m] Y-displacement of detector wrt. rotation point
* Ld:       [m] Detector width
* det_rot:  [m] Detector rotation
* mos: [arcmin] Monochromator mosaicity
* extra:  [deg] Perturbation rotation angle
*
* %End
*******************************************************************************/
DEFINE INSTRUMENT Test_Monochromator_bent_complex(
double sample_x=0.005, 
double sample_y=0.015, 
double L0=1.38000,
double L1=2.47143,
double Ld=2,    
double det_rot=-6.00000, 
double mos=60,
double extra=0)

DECLARE
%{
int scat=0;
double zwidth[92];
double yheight[92];
double xthic[92];
double radius_x[92];

double rad_y[92];
double angle_to_cut[92];
double mosaicity[92];
double mosaic_anisotropy[92];
double domainthickness[92];
double temperature[92];

double x_pos[92];
double y_pos[92];
double z_pos[92];
double x_rot[92];
double y_rot[92];
double z_rot[92];
char input_planes[552];
double z_test[2];
double y_test[2];
double z_test1[2];
double y_test1[2];
%}

USERVARS
%{
%}

INITIALIZE
%{
double zwidths[92] = {0.2197343148891427,0.21851662382435405,0.21863405085579096,0.21887923102770046,0.21763595236331731,0.21916770699832394,
0.21790459623402442,0.21938589620503104,0.2181049445014556,0.2181063285119831,0.21824096546427457,0.2182115443018055,
0.21831670131730485,0.21825863515984317,0.21957865782818686,0.2182517192738071,0.2195305601068976,0.21819494345196064,
0.21943476452805352,0.21809246919692732,0.2192954559442436,0.21794845682068875,0.21911680460501007,0.21894037547212752,
0.218902963222191,0.21871102092107653,0.21865804949600587,0.21845270461690514,0.2183861329683205,0.21816946660446723,
0.21921392641647613,0.21912367287870244,0.2188862140335372,0.2187872615815458,0.21854363663449983,0.21952626821580679,
0.21819001184203463,0.2191545734735187,0.21903549011867535,0.21877768059159686,0.21971235368003636,0.2183992222474836,
0.219321148018916,0.2180227567820189,0.2189339613220626,0.21983419802910426,0.2185542302779125,0.21944686931063473,
0.21818530879432896,0.21907230049847404,0.21882694908314132,0.2187137299201356,0.2195900015613719,0.21837431655944875,
0.21924982621604722,0.219026780799764,0.2189337280803016,0.21872475597140076,0.21864467911389726,0.21845120999072792,
0.2193302992212166,0.21926758381940015,0.21909463981503918,0.21904869103717958,0.2188948132613444,0.2188670259851676,
0.2187334921384259,0.2196382796835481,0.21861325866508402,0.21953054665239324,0.21853658837875467,0.21946789868840377,
0.2185057955178557,0.2194525512438209,0.21852297286357847,0.2194864135678103,0.2185898075442736,0.21957084410031974,
0.21870721473148716,0.21970605757408443,0.21887442888344133,0.21892020147527402,0.21908618062200894,0.21914730837379576,
0.21931902496292574,0.20670166166007542,0.19241245727828765,0.17737698045770245,0.1656856367376603,0.1459212750307583,
0.12446466823304277,0.11098741731727405};

double rad_x[92] = {3.329313177002839,3.311881514701853,3.29429167755437,3.277495587285942,
3.2606185764253204,3.2438768956404487,3.227391346434539,3.2110568239487653,3.194972929460654,
3.1787203266653004,3.1633852095924557,3.147547076579821,3.132646970881249,3.1172309930954767,
3.1023842999933335,3.0877823662742565,3.0733766419594746,3.0592110552572045,3.0452477212205635,
3.0315209148530133,3.0180005110742476,3.004714181987477,2.991636124462846,2.978405079927402,
2.9661505753146717,2.9533569931109,2.9415364414078464,2.9291782526563934,2.9177855288105428,
2.9058566594124486,2.8945135711646834,2.8837489524382365,2.872450364506867,2.8620932713107985,
2.851203292476152,2.8408790030930624,2.8307437740847488,2.8208041535274497,2.8114061921345948,
2.801476268507644,2.792084517696017,2.7828573206773544,2.773806048982262,2.764907186230193,
2.7561732513554853,2.7475882889066594,2.7391353201608193,2.730827742016332,2.722634541020616,
2.714570829094548,2.7062685238277764,2.6987467483692584,2.690978120634842,2.6832724757123394,
2.6756435375040817,2.6677165720894624,2.6605092203473264,2.6526360043900774,2.6454556636631192,
2.6375664648827177,2.629993257881364,2.622712174163109,2.6146397212469155,2.607177760465036,
2.5988515184046777,2.591096052673526,2.582383776965098,2.5738053239730156,2.564932092151773,
2.5557239483500633,2.546116378831259,2.5360469233411194,2.525443022381893,2.5142089557099707,
2.5022603394565994,2.489449481110433,2.475669873178469,2.4606927393421643,2.444369885795708,
2.4263256928303605,2.4063342819010383,2.3829139589912622,2.3579914704907288,2.3266705223057134,
2.2911634326656074,2.2738116080358397,2.2604686043215536,2.254157967881726,2.2374508894122194,
2.203648057206642,2.1897210485571867,2.1760773722136277};

double z_poss[92] = {
0.8160969275531365,0.828241513543355,0.8403444097257459,0.8524059507810806,
0.8644264533211509,0.8764062147965237,0.8883455123550597,0.900244601649273,
0.9121037155906945,0.923923063049221,0.9357028274955919,0.9474431655848734,
0.959144205679012,0.970806046306373,0.9824287545561586,0.9940123644056822,
1.0055568749783728,1.0170622487304204,1.028528409564016,1.0399552408650925,
1.0513425834635772,1.0626902335141533,1.073997940295611,1.0852654039269511,
1.0964922729984465,1.1076781421160384,1.1188225493574984,1.129924973638997,
1.1409848319908342,1.152001476741336,1.162974192608084,1.1739021936959633,
1.1847846204017234,1.1956205362251344,1.2064089244871345,1.217148684955769,
1.2278386303811561,1.238477482941195,1.2490638706002928,1.2595963233838925,
1.2700732695723023,1.2804930318179437,1.2908538231909437,1.3011537431587443,
1.311390773506321,1.321562774204514,1.3316674792349716,1.3417024923813123,
1.3516652829971976,1.361553181763262,1.3713633764461264,1.3810929076740002,
1.390738664744927,1.400297381485049,1.4097656321759322,1.4191398275715361,
1.4284162110270642,1.4375908547636254,1.446659656294374,1.4556183350395302,
1.4644624291594543,1.4731872926366916,1.4817880926396607,1.4902598072023712,
1.4985972232561542,1.5067949350510017,1.5148473430055747,1.5227486530262035,
1.5304928763364627,1.5380738298597985,1.5454851371984957,1.5527202302527092,
1.5597723515235127,1.5666345571437739,1.5732997206801214,1.5797605377483845,
1.5860095314834648,1.592039058902818,1.5978413182002487,1.6034083570038864,
1.6087320816286401,1.613804267349358,1.618616569716168,1.623160536928094,1.6274276232751075,
1.6314092036520502,1.635096589140666,1.6384810436481398,1.6415538015821203,1.6467291309272123,
1.6505525962219825,1.6529550363727945};

double y_rots[92] = {
    12.224549965444096,12.429257989386507,12.634843158490595,12.84129280223138,13.048593001603237,
    13.256729490734779,13.465687235094835,13.675450818084583,13.886003568881412,14.097330252327822,
    14.309415373618535,14.522234313455478,14.735767822999637,14.950004573665113,15.16491513549195,
    15.380478988701022,15.596681998153974,15.813488772480055,16.030887416508328,16.248842737107264,
    16.467337037753822,16.68634088217501,16.905821363786036,17.125760443295878,17.346123007548307,
    17.56687828416417,17.787994945649782,18.00944062658002,18.23118416483346,18.45319101858919,
    18.67542464290343,18.89784972804478,19.120428896795943,19.343122332111083,19.56588783431728,
    19.788686864570586,20.01148052879937,20.234222176494512,20.456865161803478,20.67937207945626,
    20.901685240279463,21.12376752227843,21.34556080862697,21.56701975843431,21.788092839172617,
    22.008725844738397,22.228863759417912,22.4484514999487,22.667432443725048,22.885748373513447,
    23.10333940242943,23.320146558080612,23.536111660291084,23.751161135397965,23.965242297427995,
    24.178277520953223,24.39021047468169,24.600968943670047,24.810481786293614,25.018678650587827,
    25.225486937555583,25.430834734009842,25.634651399517963,25.836852488110786,26.03737125093616,
    26.23612182304203,26.43302495282961,26.62800843417343,26.820981767875,27.011865856524135,
    27.20058108787477,27.387040135180655,27.571148722242455,27.752837423837832,27.932001835905968,
    28.108561766738394,28.282428710990647,28.45350489516206,28.62169684116235,28.78690003464767,
    28.949037231991614,29.10800625807111,29.263677094830634,29.415964179519083,29.5647341124584,
    29.70985123904334,29.85123876074083,29.988616895395413,30.1218449608264,30.374816895175396,
    30.60585732884762,30.807078570093147};
strcpy(input_planes, "Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;"
"Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111;Si111");
for (int i=0; i<92; i++){
    rad_y[i]=0;
    xthic[i] = 0.0005;
    yheight[i] = 0.02;
    mosaicity[i] = mos;
    zwidth[i] = zwidths[i];
    radius_x[i] = rad_x[i];
    domainthickness[i] = 10;
    temperature[i] = 300;
    mosaic_anisotropy[i] = 1;
    angle_to_cut[i] = -22 + extra;
    x_pos[i] = 0;
    y_pos[i] = 0;
    z_pos[i] = z_poss[i];
    x_rot[i] = 0;
    y_rot[i] = y_rots[i];
    z_rot[i] = 0;
}
z_test[0] = 0.8160969275531365;
z_test[1] = 1.6529550363727945;
y_test[0] = 12.224549965444096;
y_test[1] = 30.807078570093147;

z_test1[0] = 1.6529550363727945;
y_test1[0] = 30.807078570093147;
%}

TRACE

COMPONENT origin = Progress_bar()
AT (0, 0, 0) RELATIVE ABSOLUTE

// Source should be white source with variable dimensions
COMPONENT source = Source_div(
    xwidth=sample_y, 
    yheight=sample_x, 
    focus_aw=1, 
    focus_ah=2, 
    E0=5, 
    dE=2)
    
AT (0, 0, 0) RELATIVE origin

COMPONENT rotator = Arm()
AT (0, 0, 0) RELATIVE source
ROTATED (0, 0, -90) RELATIVE source


COMPONENT psd_test = PSD_monitor(
    filename="psd_incoming", 
    xmin=-0.1, 
    xmax=0.1, 
    ymin=-0.1, 
    ymax=0.1, 
    restore_neutron=1)
AT (0, 0, 0.25) RELATIVE source

COMPONENT e_monitor = E_monitor(
    nE=501, 
    filename="E_start", 
    xwidth=1, 
    yheight=1, 
    Emin=3.0, 
    Emax=7.5,
    restore_neutron=1)
AT (0, 0, 1e-9) RELATIVE PREVIOUS

COMPONENT mono_arr = Monochromator_bent_complex(
zwidth = zwidth,
yheight = yheight,
xthickness = xthic,
radius_x = radius_x,
radius_y = rad_y,
mosaicity = mosaicity,
mosaic_anisotropy = mosaic_anisotropy,
domainthickness=domainthickness,
temperature=temperature,
angle_to_cut_horizontal = angle_to_cut,
plane_of_reflection = input_planes,
n_crystals=92,
x_pos=x_pos,
y_pos=y_pos,
z_pos=z_pos,
x_rot=x_rot,
y_rot=y_rot,
z_rot=z_rot,
draw_as_rectangles=0,
verbose=0,
optimize=1)
AT (0,0,0) RELATIVE source
ROTATED (0,extra,0) RELATIVE source
EXTEND %{
    if(SCATTERED){scat=final_reflection;}
%}

COMPONENT detector_pos = Arm()
AT (0, L1,L0) RELATIVE rotator

COMPONENT detector = Arm()
AT (0,0,0) RELATIVE detector_pos
ROTATED (90+det_rot,0,90) RELATIVE detector_pos

COMPONENT psd_monitor_end = PSD_monitor(
    nx=1001, 
    ny=1001, 
    xwidth=Ld, 
    yheight=0.5,
   filename="psd_monitor_end.dat",
    restore_neutron=1)
// WHEN (scat > 1)
AT (0, 0, 1e-9) RELATIVE PREVIOUS



COMPONENT E_PSD_mon_end = Monitor_nD(
    options ="x limits=[-0.5,0.5] bins=1001.0 energy limits=[2.7 7.15] bins=4451.0",
    filename="E_end.dat", 
    xwidth=Ld, 
    yheight=0.5,
	restore_neutron=1)
WHEN(scat>0)
AT (0, 0, 1e-9) RELATIVE PREVIOUS

FINALLY
%{
%}

END
